<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="../style.css">
  <title>Project 1: SEPTA Next To Arrive</title>

  <style>
    #septa-project {
      border: 2px solid #76c7c0;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      background-color: #1a1a1a;
      max-width: 1000px;
      width: 90%;
      margin: 1rem 0;
    }

    .red{
        color: #ff2600;
        font-weight: bold;
      }

    main {
      display: flex;
      justify-content: flex-start;
      padding: 0 2rem;
      width: 100%;
      
    }

    #stationForm{
      padding: 0 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    #stationForm label {
      display: block;
      margin-bottom: 0.3rem;
      font-weight: 500;
      color: #76c7c0;
      font-size: 1.1rem;
    }

    #stationForm input[type="text"] {
      border: 1px solid #76c7c0;
      border-radius: 6px;
      padding: 12px 15px;
      background-color: #121212;
      color: #dcdcdc;
      width: 70%;
      max-width: 500px;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
      font-size: 1.1rem;
    }

    #stationForm input[type="text"]:focus {
      border-color: #5bb1a8;
      box-shadow: 0 0 0 2px rgba(118, 199, 192, 0.3);
      outline: none;
    }

    #stationForm button {
      background-color: #76c7c0;
      color: #121212;
      border: none;
      border-radius: 6px;
      padding: 12px 20px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
      font-size: 1.1rem;
      max-width: 250px;
    }

    #stationForm button:hover {
      background-color: #5bb1a8;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    #stationForm button:active {
      transform: translateY(0);
    }

    #septa-table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin-top: 1.5rem;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    #septa-table th, #septa-table td {
      padding: 12px;
      border: 1px solid #2a2a2a;
      text-align: left;
    }

    #septa-table th {
      background-color: #76c7c0;
      color: #121212;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 0.9rem;
      letter-spacing: 0.5px;
    }

    #septa-table tr:nth-child(even) {
      background-color: #222;
    }

    #septa-table tr:hover {
      background-color: #2d2d2d;
    }

    #loading, #error-msg {
      margin: 1.5rem 0;
      font-weight: bold;
      color: #fff;
      text-align: center;
      padding: 10px;
      border-radius: 6px;
    }

    #loading {
      background-color: rgba(118, 199, 192, 0.2);
    }

    #error-msg {
      background-color: rgba(255, 99, 71, 0.2);
      color: #ff6347;
    }

    .schedule-details {
      margin: 0;
      width: 100%;
      color: #dcdcdc;
      border: none;
    }

    .schedule-row {
      background-color: #1c3231 !important;
      transition: all 0.3s ease;
    }
    
    .schedule-row td {
      padding: 0 !important;
    }
    
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      background-color: rgba(118, 199, 192, 0.05);
    }
    
    .schedule-table th {
      background-color: rgba(118, 199, 192, 0.2) !important;
      color: #76c7c0 !important;
      font-weight: bold;
      padding: 10px !important;
      text-align: center !important;
      letter-spacing: 1px;
      border-bottom: 2px solid #76c7c0 !important;
    }
    
    .schedule-table td {
      padding: 8px 12px !important;
      text-align: left;
      border: none;
      border-bottom: 1px solid #333 !important;
    }
    
    .schedule-table tr:last-child td {
      border-bottom: none !important;
    }
    
    .schedule-table tr:nth-child(even) {
      background-color: rgba(118, 199, 192, 0.05);
    }
    
    .schedule-table tr:hover {
      background-color: rgba(118, 199, 192, 0.1);
    }
    
    .train-link {
      color: #76c7c0;
      text-decoration: none;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s ease;
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    .train-link:hover {
      background-color: rgba(118, 199, 192, 0.2);
      transform: translateY(-1px);
    }
    
    .train-link:active {
      transform: translateY(0);
    }

    .on-time {
      color: #4caf50; /* Green color for on time */
      font-weight: bold;
    }
    
    .delayed {
      color: #ff5252; /* Red color for delays */
      font-weight: bold;
    }

    @media (max-width: 768px) {
      #septa-project {
        width: 95%;
        padding: 1.5rem;
        margin: 1rem auto;
      }

      main {
        padding: 0 1rem;
        justify-content: center;
      }
      
      #stationForm input[type="text"] {
        width: 100%;
        max-width: none;
      }
      
      #stationForm button {
        width: 100%;
        max-width: none;
      }
      
      #septa-table {
        font-size: 0.9rem;
      }
      
      #septa-table th, #septa-table td {
        padding: 8px;
      }
      
      .schedule-table {
        font-size: 0.85rem;
      }
      
      .schedule-table td {
        padding: 6px 8px !important;
      }
    }
    
    @media (max-width: 480px) {
      #septa-table {
        font-size: 0.8rem;
      }
      
      #septa-table th, #septa-table td {
        padding: 6px 4px;
      }
      
      #septa-table th {
        font-size: 0.75rem;
      }
      
      .schedule-table th {
        font-size: 0.8rem;
      }
      
      .schedule-table td {
        padding: 6px 4px !important;
      }
      
      .train-link {
        padding: 2px 4px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Project 1: SEPTA Next To Arrive</h1>
    <hr>
    <h3>This project serves to provide real-time train arrival information for SEPTA riders.</h1>
    <p>Personally, I use this project to solve the problem of not having an easy station to station schedule system that gives me the information I need quickly and efficiently.</p>
    <p>It uses the SEPTA Next To Arrive API to fetch real-time data and display it in a user-friendly table format.</p>
    <hr>
    <i> 
      <p>Click on a train number to view its schedule.</p>
    </i>
    <hr>
    <p class="red">Note: This project is a work in progress and may not cover all edge cases. Also due to SEPTA API restrictions, you need to enter the full (case-sensitive) station name.
  </header>

  <main>
    <section id="septa-project">
      <h2>Next To Arrive</h2>
      <form id="stationForm">
        <label for="origin">Starting Station:</label>
        <input type="text" id="origin" name="origin" placeholder="e.g., 30th Street Station" required>

        <label for="destination">Ending Station:</label>
        <input type="text" id="destination" name="destination" placeholder="e.g., Trevose" required>

        <button type="submit">Get Real-Time Data</button>
      </form>

      <div id="loading" style="display: none;">Loading data... (hang tight!)</div>
      <div id="error-msg" style="display: none;"></div>

      <table id="septa-table" style="display: none;">
        <thead>
          <tr>
            <th>Train</th>
            <th>Line</th>
            <th>Departure</th>
            <th>Arrival</th>
            <th>Delay</th>
            <th>Direct</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <nav>
    <a class="footer-links" href="../index.html">home</a><br>
    <a class="footer-links" href="../hobbies/hobbies.html">hobbies</a><br>
    <a class="footer-links" target="_blank" href="https://www.linkedin.com/in/luan-merolli-75a4161b7/">linkedin</a>
  </nav>

  <script>
    async function fetchSeptaData(origin, destination) {
      const encodedURL = encodeURIComponent(`https://www3.septa.org/api/NextToArrive/index.php?req1=${origin}&req2=${destination}&req3=15`);
      const proxyURL = `https://api.allorigins.win/get?url=${encodedURL}`;
    
      try {
        const response = await fetch(proxyURL);
        if (!response.ok) throw new Error('Network response error');
        const wrappedData = await response.json();
        const data = JSON.parse(wrappedData.contents);
        return data;
      } catch (error) {
        console.error(error);
        return null;
      }
    }
    
    async function fetchTrainSchedule(trainNum) {
      const encodedURL = encodeURIComponent(`https://www3.septa.org/api/RRSchedules/index.php?req1=${trainNum}`);
      const proxyURL = `https://api.allorigins.win/get?url=${encodedURL}`;
    
      try {
        const response = await fetch(proxyURL);
        if (!response.ok) throw new Error('Network response error');
        const wrappedData = await response.json();
        const data = JSON.parse(wrappedData.contents);
        return data;
      } catch (error) {
        console.error(error);
        return null;
      }
    }
    
    function displayTrainSchedule(schedule, trainNum) {
      const scheduleDiv = document.createElement('div');
      scheduleDiv.classList.add('schedule-details');
      
      if (!schedule || schedule.length === 0) {
        scheduleDiv.textContent = "No schedule found for train " + trainNum;
        return scheduleDiv;
      }

      const table = document.createElement('table');
      table.classList.add('schedule-table');
      
      // Add header
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      headerRow.innerHTML = `
        <th colspan="2">Train ${trainNum} Schedule</th>
      `;
      thead.appendChild(headerRow);
      table.appendChild(thead);
      
      // Add schedule rows
      const tbody = document.createElement('tbody');
      schedule.forEach(stop => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${stop.station}</strong></td>
          <td>${stop.sched_tm}</td>
        `;
        tbody.appendChild(row);
      });
      
      table.appendChild(tbody);
      scheduleDiv.appendChild(table);
      return scheduleDiv;
    }
    
    function populateTable(data) {
      const tbody = document.querySelector('#septa-table tbody');
      tbody.innerHTML = '';
    
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6">No trains found for these stations.</td></tr>';
        return;
      }
    
      data.forEach(item => {
        // Determine delay class
        const delayClass = item.orig_delay === 'On time' ? 'on-time' : 'delayed';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td><a href="#" class="train-link" onclick="event.preventDefault(); toggleSchedule('${item.orig_train}', this)">${item.orig_train}</a></td>
          <td>${item.orig_line}</td>
          <td>${item.orig_departure_time}</td>
          <td>${item.orig_arrival_time}</td>
          <td class="${delayClass}">${item.orig_delay}</td>
          <td>${item.isdirect === 'true' ? 'Yes' : 'No'}</td>
        `;
        tbody.appendChild(row);
      });
    }

    async function toggleSchedule(trainNum, link) {
      const row = link.closest('tr');
      const nextRow = row.nextElementSibling;
      
      // Check if the schedule row already exists
      if (nextRow && nextRow.classList.contains('schedule-row')) {
        // If it exists, toggle its visibility
        if (nextRow.style.display === 'table-row') {
          nextRow.style.display = 'none';
        } else {
          nextRow.style.display = 'table-row';
        }
      } else {
        // If it doesn't exist, create it
        const loadingCell = document.createElement('td');
        loadingCell.colSpan = 6;
        loadingCell.textContent = 'Loading schedule...';
        
        const scheduleRow = document.createElement('tr');
        scheduleRow.classList.add('schedule-row');
        scheduleRow.appendChild(loadingCell);
        scheduleRow.style.display = 'table-row';
        
        // Insert after the train row
        if (row.nextSibling) {
          row.parentNode.insertBefore(scheduleRow, row.nextSibling);
        } else {
          row.parentNode.appendChild(scheduleRow);
        }
        
        // Fetch and display the schedule
        const scheduleData = await fetchTrainSchedule(trainNum);
        const scheduleDetails = displayTrainSchedule(scheduleData, trainNum);
        
        loadingCell.innerHTML = '';
        loadingCell.appendChild(scheduleDetails);
        scheduleDetails.style.display = 'block';
      }
    }
    
    document.getElementById('stationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const origin = document.getElementById('origin').value;
      const destination = document.getElementById('destination').value;
      document.getElementById('loading').textContent = 'Loading data... (hang tight!)';
      document.getElementById('loading').style.display = 'block';
      document.getElementById('error-msg').style.display = 'none';
      document.getElementById('septa-table').style.display = 'none';
    
      const data = await fetchSeptaData(origin, destination);
      document.getElementById('loading').style.display = 'none';
    
      if (data === null) {
        document.getElementById('error-msg').textContent = 'Error fetching data, please try again.';
        document.getElementById('error-msg').style.display = 'block';
        return;
      }
    
      document.querySelector('#septa-project h2').textContent = `Next To Arrive: ${origin} ➡️ ${destination}`;
      document.getElementById('septa-table').style.display = 'table';
      populateTable(data);
    });
  </script>
</body>
</html>
